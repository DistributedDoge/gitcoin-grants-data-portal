name: CI

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout
      uses: actions/checkout@v3

    - name: Build Docker
      run: docker build -t davidgasquez/ggdp:latest .

    - name: Run Make
      run: docker run --rm -v $PWD/:/workspaces/gitcoin-grants-data-portal/ davidgasquez/ggdp:latest make run
      
    - name: Publish Web
      run: docker run --rm -v $PWD/:/workspaces/gitcoin-grants-data-portal/ davidgasquez/ggdp:latest quarto render reports/sandbox.ipynb -o index.html && mv index.html data/
    
    - name: Upload to IPFS
      uses: web3-storage/add-to-web3@v2
      id: web3
      with:
        web3_token: ${{ secrets.WEB3_STORAGE_TOKEN }}
        path_to_add: 'data'
      
    - run: echo ${{ steps.web3.outputs.cid }}
    - run: echo ${{ steps.web3.outputs.url }}
